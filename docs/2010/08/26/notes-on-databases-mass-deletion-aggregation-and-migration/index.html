<!DOCTYPE html><html lang="en"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Note on databases: mass deletion, aggregation and migration | Sketchy Polytopes</title><meta name="description" content="Algorithms, optimization; systems, data, and people "><meta itemprop="name" content="Umayr Hassan"><meta itemprop="description" content="Algorithms, optimization; systems, data, and people "><meta itemprop="image" content="http://localhost:4000/assets/images/form_contact.jpg"><meta property="og:url" content="http://localhost:4000/2010/08/26/notes-on-databases-mass-deletion-aggregation-and-migration/"><meta property="og:type" content="website"><meta property="og:title" content="Note on databases: mass deletion, aggregation and migration | Sketchy Polytopes"><meta property="og:site_name" content="Sketchy Polytopes"><meta property="og:description" content="Algorithms, optimization; systems, data, and people "><meta property="og:image" content="http://localhost:4000/assets/images/form_contact.jpg"><meta name="twitter:url" content="http://localhost:4000/2010/08/26/notes-on-databases-mass-deletion-aggregation-and-migration/"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Note on databases: mass deletion, aggregation and migration | Sketchy Polytopes"><meta name="twitter:site" content="Sketchy Polytopes"><meta name="twitter:description" content="Algorithms, optimization; systems, data, and people "><meta property="twitter:image" content="http://localhost:4000/assets/images/form_contact.jpg"><link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico"><link rel="stylesheet" href="/assets/css/app.min.css"><link rel="alternate" type="application/rss+xml" title="Sketchy Polytopes" href="/feed.xml"><link rel="canonical" href="/2010/08/26/notes-on-databases-mass-deletion-aggregation-and-migration/"> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ tex2jax: { skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'], inlineMath: [['$','$']] } }); </script> <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body id="note-on-databases-mass-deletion-aggregation-and-migration" class="post-layout"><header class="header"> <a class="header__title" href="http://localhost:4000/">Sketchy Polytopes</a><nav><ul class="header__list"><li><a href="/">Posts</a></li><li><a href="/notes">Notes</a></li><li><span class="popup__open">Contact</span></li></ul></nav></header><main class="ðŸ’ˆ"><div class="post"><article itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting"><div class="post__header section-padding--double"><div class="grid-small"><h2 itemprop="name headline">Note on databases: mass deletion, aggregation and migration</h2><time class="post__date" datetime="2010-08-26T00:00:00-07:00" itemprop="datePublished">26 Aug 2010</time></div></div><div class="post__content section-padding"><div class="grid"><div id="markdown" itemprop="articleBody"><p><em>Scenario</em>: Our company stores ad statistics (e.g. ads viewed) and properties (e.g. homepage) in a database so that marketing folks can query the database according to their needs. The database is MS SQL since it was thought that it would provide better performance for certain queries. This year, the database size grew rapidly such that secondary memory had to be supplemented with USB-based 2TB Flash memory. Eventually, even that filled up and the database was unable to load new data. Thus, our goals are to:</p><ul><li>Delete all data before January 01, 2010, since itâ€™s too old to be useful</li><li>Upload the backlog of data into the data base</li><li>Modify the database update script to aggregate all incoming data over certain keys</li><li>Migrate the database to a new one with an updated schema</li></ul><p><em>Observation 1</em>: Significant differences between SQL scripts written for MS-SQL and MySQL. For example, <a href="http://dev.mysql.com/doc/refman/5.0/en/load-data.html">LOAD DATA INFILE</a> queries in MySQL are replaced by <a href="http://msdn.microsoft.com/en-us/library/ms188365.aspx">BULK INSERT</a> queries in MS-SQL. Moreover, bulk queries in MS-SQL may requires explicit permissions from the DBA to be carried out.</p><p><em>Observation 2</em>: The company actually maintains two databases: the primary database stores the various statistics and properties, while the <a href="http://www.microsoft.com/sqlserver/2008/en/us/Analysis-Services.aspx">Cube</a> is a <a href="http://en.wikipedia.org/wiki/MOLAP">MOLAP</a> that processes (using XML queries) the data (partitioned by the month) in the primary database and then stores the results, to make certain queries (now made using an ODC-based <a href="http://msdn.microsoft.com/en-us/library/ms178798.aspx">PivotTable</a>) much faster and easy to invoke. Before issuing bulk delete, we needed ensure that modifying data did not crash the Cube.</p><p>Bulk delete was nearly disastrous. It seems that the MS SQL Server was writing to C drive while deleting data from the Flash memory. The available space on C drive fell from &lt;100GB to 24Gb in an hour. This was primarily because the database log file kept on increasing. We had better luck deleting rows in batches. How large should a batch be? For example, a batch of 500000 rows took ~2.5min while five batches of 50 million rows took more than five hours. After running the deletion query, we <a href="http://technet.microsoft.com/en-us/library/ms190757.aspx">shrank the log files</a> (located on C drive), as well as the <a href="http://technet.microsoft.com/en-us/library/ms189035.aspx">database</a> (on the Flash-based U drive), to reclaim free space.</p><p>Another problem is determining the number of batches, which would requires us to know the total number of rows being deleted beforehand. Given that this number is very large (in billions), a count query might take too long. We roughly estimated the number of batches by counting the rows being affected for ten days and then using the fact that we had around six months of data to be deleted. Hereâ€™s a script to automate the process:</p><pre><code class="language-roomsql">Set rowcount to 50000000 to limit number of deletes per batch
 SET ROWCOUNT 50000000
 
 DECLARE @innerCount INT
 SET @innerCount = 0
 
 DECLARE @outerCount INT
 SET @outerCount = 0
 
 WHILE (@outerCount &lt; 3)
 BEGIN
   WHILE (@innerCount &lt; 5)
   BEGIN
   BEGIN TRANSACTION
   -- Use tablockx and holdlock to obtain and hold
   -- an immediate exclusive table lock. This unusually
   -- speeds the update because only one lock is needed.
   DELETE [reporting].[dbo].[stats] WITH (tablockx, holdlock)
   WHERE [stats_date] &lt; 14610
   -- Commit the transaction
   COMMIT
 SET @innerCount = (@innerCount + 1)
 END
 -- Shrink log files to free up space for future transactions
 -- Note that reporting_log is the name of the log file
 DBCC SHRINKFILE (reporting_log, 1);
 -- Reclaim free space in the database. This might take a while.
 -- Note that reporting is the name of the database being shrunk
 DBCC SHRINKDATABASE (reporting);
 
 SET @outerCount = (@outerCount + 1)
 END
 
-- Remove rowcount limitation
SET ROWCOUNT 0
 
-- Delete the rest of rows, less than ROWCOUNT
BEGIN TRANSACTION
DELETE [reporting].[dbo].[stats] WITH (tablockx, holdlock)
WHERE [stats_date] &lt; 14610
COMMIT
-- Validate no rows are left to be deleted
SELECT COUNT(*)
FROM [reporting].[dbo].[stats]
WHERE [stats_date] &lt; 14610
-- Shrink again
DBCC SHRINKFILE (reporting_log, 1);
DBCC SHRINKDATABASE (reporting);
</code></pre><p>On our system, this query deleted 750 million rows, took 11.5hr to complete, freed up 227GB of memory on U: drive and returned the free space in C: to its normal state. We needed to runs this query a couple more times to delete all rows, taking up 22hr more and finally freeing up ~450GB on U: drive.</p><p>It is now trivial to write a <a href="http://baishui.info/orelly/linux/dbi/ch08_02.htm">Perl script</a> that can remotely connect to a database server (using DBD::Proxy, DBI and DBD::ODBC modules), and execute this query.</p><p><em>Observation 3</em>: Once deletion is complete, we may start aggregation data over certain columns to further reduce database size. In our case, the table in question is composed of two kinds of columns: keys and values. We may aggregate values (e.g. sum them) for given keys. Thus, assuming that (key_i+1â€¦key_N) are the keys we are aggregating on, this yields an aggregation query with the following format:</p><pre><code class="language-roomsql">INSERT INTO aggregated_table (key1...key_i, value1...value_M)
(
    SELECT key1...key_i, SUM(value1)...SUM(value_M)
    FROM unaggregated_table
    GROUP BY key1...key_i
)
</code></pre><p>Finally, as for migration, which is need to change the number of columns in the database, we need to ensure that the aggregated_table above, when created, include the new columns.</p><p><em>Observation 4</em>: What if one accidentally truncates a table? It seems that that only way to undo truncation is by ensuring that it is carried out within a transaction. More information on code and limitations available <a href="http://blog.sqlauthority.com/2010/03/04/sql-server-rollback-truncate-command-in-transaction/">here</a>.</p></div><ul class="post__social"><li><a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2010/08/26/notes-on-databases-mass-deletion-aggregation-and-migration/" target="_blank"><i class="fa fa-facebook"></i></a></li><li><a href="https://twitter.com/intent/tweet?&text=Note on databases: mass deletion, aggregation and migration+http://localhost:4000/2010/08/26/notes-on-databases-mass-deletion-aggregation-and-migration/+by+Umayr Hassan" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="https://plus.google.com/share?url=http://localhost:4000/2010/08/26/notes-on-databases-mass-deletion-aggregation-and-migration/" target="_blank"><i class="fa fa-google-plus"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?mini=true&source=Note on databases: mass deletion, aggregation and migration&summary=&url=http://localhost:4000/2010/08/26/notes-on-databases-mass-deletion-aggregation-and-migration/" target="_blank"><i class="fa fa-linkedin"></i></a></li><li><a href="https://www.stumbleupon.com/badge/?url=http://localhost:4000/2010/08/26/notes-on-databases-mass-deletion-aggregation-and-migration/" target="_blank"><i class="fa fa-stumbleupon"></i></a></li><li><a href="https://www.reddit.com/submit?url=http://localhost:4000/2010/08/26/notes-on-databases-mass-deletion-aggregation-and-migration/" target="_blank"><i class="fa fa-reddit-alien"></i></a></li><li><a href="https://www.tumblr.com/share/link?url=http://localhost:4000/2010/08/26/notes-on-databases-mass-deletion-aggregation-and-migration/" target="_blank"><i class="fa fa-tumblr"></i></a></li><li><a href="https://www.pinterest.com/pin/create/link/?description=&media=&url=http://localhost:4000/2010/08/26/notes-on-databases-mass-deletion-aggregation-and-migration/" target="_blank"><i class="fa fa-pinterest"></i></a></li></ul></div></div><div class="section-padding--none"><div class="grid"><hr class="sep"/></div></div><div class="section-padding"><div class="grid-small"> <span class="post__author">Posted by <a href="http://umayrh.github.io" title="More By Umayr Hassan">Umayr Hassan</a></span><p class="post__bio"></p></div></div></article></div></main><footer class="footer section-padding"><div class="grid"><div class="subscribe" id="subscribe"><div class="subscribe__container"> <span class="subscribe__title">Subscribe</span><p class="subscribe__text">Get a weekly email of posts Iâ€™ve added to the site.</p><form method="POST" action="&amp;c=?" id="mc-signup" name="mc-embedded-subscribe-form" novalidate><div style="position: absolute; left: -5000px;" aria-hidden="true"> <input type="text" name="" tabindex="-1" value=""></div><div class="form-group"> <input id="mce-EMAIL" type="email" name="EMAIL" placeholder="Email Address"></div><div class="form__btn"> <input id="mc-submit" type="submit" value="Sign Up" name="subscribe"></div></form><p class="subscribe__error hidden"></p></div></div><hr class="sep--white"/><div class="footer__container"><ul class="footer__tags"><li><a class="footer__link" href="/tag/mathematics">Mathematics</a></li><li><a class="footer__link" href="/tag/algorithms">Algorithms</a></li><li><a class="footer__link" href="/tag/convex-optimization">Convex Optimization</a></li><li><a class="footer__link" href="/tag/java">Java</a></li><li><a class="footer__link" href="/tag/obit">Obit</a></li></ul><ul class="footer__social"><li><a href="https://www.linkedin.com/in/umayr/" target="_blank"><i class="fa fa-linkedin"></i></a></li><li><a href="https://github.com/umayrh" target="_blank"><i class="fa fa-github"></i></a></li><li><a href="https://gitlab.com/umayrh" target="_blank"><i class="fa fa-gitlab"></i></a></li><li><a href="https://umayrh.wordpress.com" target="_blank"><i class="fa fa-wordpress"></i></a></li></ul></div></div></footer><section class="contact popup"><div class="popup__close"><div class="popup__exit"></div></div><div class="contact__container popup__container"><div class="contact__img"><figure class="absolute-bg" style="background-image: url(/assets/images/form_contact.jpg);"></figure></div><div class="contact__content"><div class="contact__mast section-padding--half"><div class="grid"><h2>Contact</h2></div></div><div class="section-padding--none"><hr class="sep"/></div><div class="contact__form section-padding--half"><div class="grid-xlarge"> <form id="form" class="form" action="https://formcarry.com/s/UuffFC2ATgC" method="POST"><div class="form__subcontainer"><div> <label for="form-first-name">First Name</label> <input type="text" name="first-name" id="form-first-name" required></div><div> <label for="form-last-name">Last Name</label> <input type="text" name="last-name" id="form-last-name" required></div></div><div> <label for="form-email">E-Mail</label> <input type="email" name="email" id="form-email" required></div><div> <label for="form-message">Message</label> <textarea name="message" id="form-message" rows="3"></textarea></div><div class="form__submit"><div class="form__btn"> <input type="submit" value="Send"></div></div><p class="form__message"></p></form></div></div></div></div></section><script src="/assets/js/app.min.js"></script></body></html>
  