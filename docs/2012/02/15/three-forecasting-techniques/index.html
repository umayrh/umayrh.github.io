<p>How well are we doing when forecasting for online ads at <a href="http://adap.tv/" title="Adap.tv">Adap.tv</a>? Can we do better? To start answering such questions, I used <a href="http://cran.r-project.org/"><strong>R</strong></a> to experiment with three well-known forecasting techniques and used an hourly metric (transformed for data privacy) across all ads for seven days (Feb 1-Feb 7) as my training data set. Then I use each of the techniques to predict for the eight day (Feb 8), and compare the predicted values with actual data. Here’s a synopsis of the three:</p>

<p><em>1. Exponential Weighted Moving Average (EWMA)</em></p>

<p>Strictly speaking, the smoothing filter that we currently use at Adap.tv for forecasting is not EWMA, but more like Weighted Moving Average. EWMA is defined by:</p>

<p><img src="http://upload.wikimedia.org/wikipedia/en/math/a/3/a/a3a63410a8db7ce3ffae2a78d9ff74c9.png" alt="S_{t} = \alpha \times (Y_{t-1} + (1-\alpha) \times Y_{t-2} + (1-\alpha)^2 \times Y_{t-3} + ... + (1-\alpha)^k \times Y_{t-(k+1)}) + (1-\alpha)^{k+1} \times S_{t-(k+1)}" /> (<a href="http://en.wikipedia.org/wiki/Moving_average">ref</a>)</p>

<p>So, if a = 0.9, S[t] = 0.9 ( y[t-1] + 0.1*y[t-2] + 0.01*y[3] … 1e-6*y[t-7]) would be an implementation of EWMA. Instead, our implementation is be: S[t] = 0.9 ( y[t-1] + 0.9*y[t-2] + 0.81*y[3] … 0.531441*y[t-7]) / (0.9+…). The critical difference is in the way past data is weighted - with EWMA data in remote past is heavily penalized, whereas, comparatively, in our implementation it is not.</p>

<p>Fig. 1 below shows a plot that forecasts our metric for Feb 8 using Weighted Moving Average akin to our implementation. The metric forecasted for Feb 8 was 68392533 whereas observed value was 63868927, giving an absolute difference of ~7.1%. The absolute hourly differences lie between 0.6-29%.</p>

<p>[caption id=”attachment_162” align=”alignnone” width=”300”]<a href="http://umayrh.files.wordpress.com/2012/02/wma2.png"><img src="http://umayrh.files.wordpress.com/2012/02/wma2.png?w=300" alt="" title="Weighted moving average" /></a> Fig. 1[/caption]</p>

<p><em>2. Harmonic regression</em> Harmonic regression attempts to find the best-fitting periodic signals that can characterize a time series. For example, we a time series may be represented by a linear sum of sinusoids:</p>

<p><img src="http://upload.wikimedia.org/wikipedia/en/math/2/7/3/27359a25f09cb3722c2300b6daa9890e.png" alt="\frac{a_0}{2} + \sum_{n=1}^\infty \, [a_n \cos(nx) + b_n \sin(nx)]" /> (<a href="http://en.wikipedia.org/wiki/Fourier_series">ref</a>)</p>

<p>Generally, a combination of Fourier transform and least-squares regression in used to find the harmonics who linear sum best fit training data. In my experiment, I used the top seven harmonics with highest power density (i.e. contribution to the model), and then used linear regression to find their amplitudes. Fig. 2 shows the model (in red) and actual data (in blue). The forecast for Feb 8 was 60476559 whereas the observed value was 63868927, giving an absolute difference of ~5.3%. The absolute hourly differences lie between 0.05-25%.</p>

<p>[caption id=”attachment_161” align=”alignnone” width=”300”]<a href="http://umayrh.files.wordpress.com/2012/02/harmreg2.png"><img src="http://umayrh.files.wordpress.com/2012/02/harmreg2.png?w=300" alt="" title="Harmonic regression" /></a> Fig. 2[/caption]</p>

<p><em>3. Holt-Winters method</em></p>

<p>Holt-Winters method augments EWMA to account for data trends and seasonality.</p>

<p><img src="http://upload.wikimedia.org/wikipedia/en/math/f/9/5/f95f5a3f2a31fc46fbf0f719629ffc0c.png" alt="\begin{align}&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;
s_0&amp; = x_0\&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;
s_{t}&amp; = \alpha \frac{x_{t}}{c_{t-L}} + (1-\alpha)F_t\&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;
b_{t}&amp; = \beta (s_t - s_{t-1}) + (1-\beta)b_{t-1}\&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;
c_{t}&amp; = \gamma \frac{x_{t}}{s_{t}}+(1-\gamma)c_{t-L}\&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;
F_{t+m}&amp; = (s_t + mb_t)c_{(t+m) \pmod L},&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;
\end{align}" />(<a href="http://en.wikipedia.org/wiki/Exponential_smoothing">ref</a>)</p>

<p>The model I used assumes that the seasonal component is additive (instead of being multiplicative). Fig. 3 illustrates the breakdown of seasonality, trend and randomness in the data,  Fig. 4 contrasts observed data with predicted data (note that the prediction start after one period, and the phase lag in predicted data), while Fig. 5 shows Holt-Winters prediction for Feb 8 versus observed data. The forecasted metric for Feb 8 was 63801332 whereas observed value was 63868927, giving an absolute difference of ~0.11%. The absolute hourly differences lie between 1.3-20%.</p>

<p>[caption id=”attachment_159” align=”alignnone” width=”300”]<a href="http://umayrh.files.wordpress.com/2012/02/holtwintersdecomposition2.png"><img src="http://umayrh.files.wordpress.com/2012/02/holtwintersdecomposition2.png?w=300" alt="" title="Holt-Winters decomposition" /></a> Fig. 3[/caption]</p>

<p>[caption id=”attachment_157” align=”alignnone” width=”300”]<a href="http://umayrh.files.wordpress.com/2012/02/holtwintersfit2.png"><img src="http://umayrh.files.wordpress.com/2012/02/holtwintersfit2.png?w=300" alt="" title="Holt-Winters observed/forecasted" /></a> Fig. 4[/caption]</p>

<p>[caption id=”attachment_156” align=”alignnone” width=”300”]<a href="http://umayrh.files.wordpress.com/2012/02/holtwintersprediction2.png"><img src="http://umayrh.files.wordpress.com/2012/02/holtwintersprediction2.png?w=300" alt="" title="Prediction using Holt-Winters" /></a> Fig. 5[/caption]</p>

<p>TO-DO</p>

<ul>
  <li>Compare these models for other data set time ranges (weeks, months, quarters)</li>
  <li>Compare these models for other metrics by sub-populations (e.g. by view domains)</li>
  <li>Test for stationarity, or otherwise heteroscedasticity, across models and data sets. This may be critical since non-stationary time series should <em>not</em> be modeled with moving average methods</li>
  <li>Compare models when data is uniformly sampled</li>
</ul>
