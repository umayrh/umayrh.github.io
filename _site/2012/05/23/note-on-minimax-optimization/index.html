<p>At <a href="http://www.adap.tv" title="Adap.tv">Adap.tv</a>, one of my favorite projects is an ad delivery optimization feature that we internally call the “bid optimizer.” It allows an advertiser to achieve her impression, average CPM (cost per thousand impressions) and performance (click-through rate, completion rate and/or premium impression distribution) goals for a given ad. The ad bids in our second-price auction market-place to try and win impressions on selected sites.</p>

<p>In general, the bid optimizer’s objective is to minimize the $ per impression that the advertiser has to pay. But our market-place is quite volatile - at least in terms of the winning price of an impression on a given site, with specific targeting, and relatively short forecasting horizon - so forecasting errors are usually large. This problem is exacerbated if the optimizer decides to select most of the impressions from a few sites, in which case forecast error can threaten ad’s impression goal. In this post, I’ll focus on a way that the optimizer can use to improve the diversity of its site portfolio without assuming anything about the forecast accuracy.</p>

<p>If our ad was not constrained by cost and all the sites selected by the advertiser had the same number of forecasted impressions, then the optimizer would select impressions till it reaches the impression goal. For example, if each of the sites site1, site2 and site3 offered 10,000 impressions, then an optimizer with an impression goal of 18,000 can simply solve the following linear program (necessary if thousands of sites are actually involved) to see what fraction of impressions it needs from each site (there’s no objective since impression goal is fixed and there’s no cost goal):</p>

<p>Maximize
 objective_function: + 0 site3</p>

<p>Subject To
 impressions: + 10000 site3 + 10000 site2 + 10000 site1 = 18000</p>

<p>Bounds
 0 &lt;= site1 &lt;= 1
 0 &lt;= site2 &lt;= 1
 0 &lt;= site3 &lt;= 1</p>

<p>End</p>

<p>This formulation effectively only asks to see if the program has a feasible solution, or not, for a given goal and hence there’s no restriction that impressions must be bought from all sites, not just any two. The restriction to buy from as many distinct sites as possible (without violating any other, say cost or performance, constraints) would maximize our portfolio’s diversity, and is best expressed as a <em>maximin optimization</em> objective: maximize the minimum number of impressions across sites.</p>

<p>$latex \max [\min (f_1(x),…,f_n(x))] $</p>

<p>where <em>fi(x)</em> (i = 1…n) are linear functions of <em>x</em>. In fact, for our purposes, <em>fi(x)</em> = <em>Fi_xi__, where _Fi</em> represents forecasted impressions for site i and <em>xi</em> is the fraction that the optimizer is interested in.</p>

<p>Maximin optimization, in general, is a non-linear convex program. Luckily, it’s possible to reformulate it as a linear program [1] by introducing an unbounded, slack variable <em>site0</em>:</p>

<p>$latex \max z $ $latex s. t. F_{i} x_{i} \ge z $</p>

<p>Maximize
 objective_function: + site0</p>

<p>Subject To
 impressions: + 10000 site3 + 10000 site2 + 10000 site1 = 18000
 maximin1: + 10000 site1 - site0 &gt;= 0
 maximin2: + 10000 site2 - site0 &gt;= 0
 maximin3: + 10000 site3 - site0 &gt;= 0</p>

<p>Bounds
 0 &lt;= site1 &lt;= 1
 0 &lt;= site2 &lt;= 1
 0 &lt;= site3 &lt;= 1
 site0 free</p>

<p>End</p>

<p>The maximin linear program would have an optimal solution when 6000 impressions are chosen from each site, thus minimizing the absolute impression difference between any two sites.</p>

<p>But what if one of the sites could not be part of a feasible solution because otherwise it could violate other goals (e.g. if impression from a site are too expensive or vastly under-perform)? Such cases, which, unfortunately are likely to be the norm, cause this minimax formulation to fail since the minimum number of impressions across <em>all</em> sites stays at zero to (no impressions selected from at least one site) regardless of the distribution of other fractions. It is tempting to solve this by recasting the problem as:</p>

<p>$latex \max z $ $latex s. t. x^{T}_{j} F_{i} x_{i} \ge x_i z $</p>

<p>But such a quadratically-constraint program is far less efficient to solve than a linear program.</p>

<p>I hope to find a simpler solution to this problem soon.</p>

<p>Note (05/23/12):</p>

<p>While reading a StackExchange post [2], I realized that this problem could potentially be reformulated as a mixed integer linear program by introducing binary variables $latex t_1,…,t_n $ corresponding to $latex x_1,…,x_n $ such that</p>

<p>$latex t_i = 1 \Rightarrow x_i \textgreater 0 $ $latex t_i = 0 \Rightarrow x_i = 0 $</p>

<p>With the objective function being:</p>

<p>$latex \max (\sum_i t_i) $</p>

<p>But what are the right constraints for this formulation? These don’t work with the maximization objective (though will with minimization):</p>

<p>$latex x_i \leq t_i $</p>

<p>Note (05/27/12):</p>

<p>The right constraints (thanks to [3] for showing the way) are:</p>

<p>$latex x_i \geq \epsilon t_i $ $latex x_i \leq t_i $</p>

<p>$latex \epsilon $ is the smallest possible non-zero value of $latex x_i $ and, in our case,  must be the inverse of the maximum impressions from any site.</p>

<p>References: [1] <a href="http://www.stanford.edu/~boyd/cvxbook/">Convex Optimization</a> [2] http://math.stackexchange.com/questions/16788/solution-technique-to-optimize-sets-of-constraint-functions-with-objective-funct [3] <a href="http://www.aimms.com/aimms/download/manuals/aimms3om_integerprogrammingtricks.pdf">Integer Programming Tricks</a></p>
